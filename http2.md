# HTTP/2

## 简介

HTTP/2 起源于 Google 开发的 SPDY 协议，目标是为了解决 HTTP/1 的一些性能限制，加快网页加载的速度。SPDY 协议已经得到了 Chrome、Firefox 等浏览器的支持，并在实践中证明能够大幅提升性能。

HTTP/2 没有修改 HTTP 协议的语义，HTTP状态码、方法、头部字段等概念不变。HTTP/2 修改了数据传输方式，并增加了一些新特性。

## HTTP/2 数据编码

HTTP/1 文本协议，可读性好，开发简单，容易调试，缺点是效率低。

HTTP/2 消息二进制分帧，这是 HTTP/2 实现性能增强的核心，它定义了 HTTP 消息的传输编码格式。

数据流：TCP连接上的双向字节流，一个TCP连接可以承载任意数量的数据流，每个数据流都有一个唯一标识，一个数据流可以承载多条消息。

消息：一个HTTP请求或响应，每个消息包含一个或多个帧。

帧：HTTP/2 的最小通信单位，每个帧包含首部，承载了特定类型的数据，比如HTTP请求头、HTTP请求体。

## 双向数据流/多路复用

HTTP/1 半双工，数据传输只能以请求-响应的模式进行，即在一个HTTP连接上，接收到响应前无法发送第二个请求。HTTP连接也是TCP连接，占用昂贵的操作系统资源，建立连接的三次握手也导致了数据传输的延时。

浏览器通常会建立多个TCP连接来传输数据，以加快网页加载的速度，这导致浏览器占用了更多的CPU和内存，对笔记本而言电量消耗更快，同时也消耗了更多服务器资源。

HTTP 管道支持同时发送多个请求，但响应必须按顺序返回，仍存在队首阻塞的问题。如果第一个请求失败，后面的请求必须重发一次，严重影响性能。服务器必须缓存管道中的响应，占用服务器资源。

HTTP/2 真正意义上的双向数据传输，一个域名只需占用一个连接，所有数据传输都在这个连接上进行。

更有效的利用TCP连接，减少了TCP拥塞控制机制带来的延迟（慢启动、丢包恢复）。

解决了 HTTP/1 中队首阻塞的问题，提供了单连接并行请求的能力。HTTP/1 中诸多繁琐的优化工作也不再需要，比如域名分片、资源内嵌、图标合并等。

## 请求头压缩

客户端和服务端都会维护一张头部表，每次请求只增量发送有差异的头部，大大减小了头部的大小。

## 请求优先级

HTTP/2支持请求优先级，每个数据流都有一个权重表示它的优先级。服务端能优先处理优先级高的请求，客户端能更快拿到优先级高的数据，加快网页展示速度。

## 服务端推送

服务端可以主动推送客户端需要的JS和CSS文件，而不需要等到客户端发出请求才发送，可以减少资源加载延迟，加快网页加载的速度。

服务端会先发送 PUSH_PROMISE 帧，包含推送资源的HTTP头部。如果客户端已经缓存了这个资源，可以拒绝这个流。

## 流量控制

基于数据流的流量控制。TCP流控制基于一个TCP连接，粒度过于粗糙，也无法提供应用级API。HTTP/2 接收方可以为每个流和整个连接声明接收窗口大小。

接收方可以为某个流广播较低的窗口大小，以限制其传输速度。

## 调试 HTTP/2 流量


## HTTP/2 报文


## 帧类型

- DATA：用于传输 HTTP 消息体。
- HEADERS：用于传输关于流的额外的首部字段。
- PRIORITY：用于指定或重新指定引用资源的优先级。
- RST_STREAM：用于通知流的非正常终止。
- SETTINGS：用于通知两端通信方式的配置数据。
- PUSH_PROMISE：用于发出创建流和服务器引用资源的要约。
- PING：用于计算往返时间，执行“活性”检查。
- GOAWAY：用于通知对端停止在当前连接中创建流。
- WINDOW_UPDATE：用于针对个别流或个别连接实现流量控制。
- CONTINUATION：用于继续一系列首部块片段。